{% extends "dbase.html" %}
{% block title %}Ввод результатов{% endblock %}
{% block container %}container-fluid{% endblock %}
{% block extended_header %}
    <ul class="nav navbar-nav">
        <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">{{ lab.title }} <b class="caret"></b></a>
            <ul class="dropdown-menu" role="menu" style="z-index: 10000">
                {% for v in labs %}
                    {% if v.pk != lab.pk %}
                        <li><a href="/results/enter?lab_pk={{ v.pk }}">{{ v.title }}</a></li>
                    {% endif %}
                {% endfor %}
            </ul>
        </li>
    </ul>
{% endblock %}
{% block content %}
    <div class="col-md-4 col-lg-3" style="padding-right: 0">
        <div class="fastlinks">
            <a href="#" style="word-break: keep-all; white-space: nowrap" onclick="openexeclist();return false">Лист
                исполнения</a>&nbsp;&nbsp;
            <a href="#" style="word-break: keep-all; white-space: nowrap"
               onclick="openjournal();return false">Журнал</a>&nbsp;&nbsp;
            <a href="#" style="word-break: keep-all; white-space: nowrap" onclick="dayprint();return false">Печать
                результатов за день</a></div>
        <div class="panel panel-flt m5" style="margin-bottom: 10px">
            <div class="panel-body" style="padding:10px;">
                <form autocomplete="off" onsubmit="return false;">
                    <input autocomplete="false" name="hidden" type="text" style="display:none;">
                    <div class="input-group" style="margin-bottom: 5px">
                        <input type="text" class="form-control" id="search-field" name="search-field" maxlength="13"/>
                        <span class="input-group-btn">
                        <button class="btn btn-blue-nb" onclick="load_d_fast();return false;"
                                type="submit">Поиск</button>
                    </span>
                    </div>
                    <div class="btn-group" data-toggle="buttons" style="display: inline-block; width: 100%">
                        <label class="btn btn-blue-nb btn-ell active" style="width: 50%">
                            <input type="radio" name="type" id="option2" value="1" autocomplete="off" checked>
                            Номер направления
                        </label>
                        <label class="btn btn-blue-nb btn-ell" style="width: 50%">
                            <input type="radio" name="type" id="option1" value="0" autocomplete="off">
                            Номер ёмкости
                        </label>
                    </div>
                </form>
            </div>
        </div>
        <div class="panel panel-flt m2">
            <div class="panel-body" style="padding: 5px 10px;">
                <label style="float: right;">отложенные <input type="checkbox" name="def"
                                                               onchange="tgfreeze(this);"/></label>Дата приёма
                материала:
                <div class="row" style="margin-bottom: 5px">
                    <div class="col-xs-9" style="padding-right: 0;">
                        <div class="input-daterange input-group" id="datepickermain" style="margin-top: 2px">
                            <input type="text" class="input-sm form-control no-context" name="datemain-start"/>
                            <span class="input-group-addon"
                                  style="background-color: #fff;color: #000">&mdash;</span>
                            <input type="text" class="input-sm form-control no-context" name="datemain-end"/>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <button class="btn btn-primary-nb" onclick="load_tubes_and_dirs();return false;"><i
                                class="fa fa-refresh"></i></button>
                    </div>
                </div>
                <div id="lists">
                    <div class="col-xs-6" id="dirs-list">
                        <table class="table table-bordered floatThead">
                            <thead>
                            <tr>
                                <th style="text-align: center;white-space: nowrap">Направления
                                    <small class="badge">0</small>
                                </th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="col-xs-6" id="tubes-list">
                        <table class="table table-bordered floatThead">
                            <thead>
                            <tr>
                                <th style="text-align: center">Ёмкости
                                    <small class="badge">0</small>
                                </th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-6" style="text-align: right">
                        <small>дата создания направления</small>
                    </div>
                    <div class="col-xs-6" style="text-align: right">
                        <small>дата приёма материала</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-3" style="margin-top: -10px;padding-right: 0;">
        <div class="btn-group btn-group-justified" style="margin-bottom: 6px;">
            <div class="btn-group">
                <button onclick="print_results(); return false;" id="result-print" disabled
                        class="btn btn-sm btn-primary-nb btn-ell">Печать результатов
                </button>
            </div>
            <div class="btn-group">
                <button onclick="confirm_results(); return false;" id="result-confirm" disabled
                        class="btn btn-sm btn-primary-nb btn-ell">Подтвердить результаты
                </button>
            </div>
        </div>
        <table class="table table-bordered table-condensed table-responsive" id="dir_info">
            <colgroup>
                <col width="26%">
                <col width="32%">
                <col width="21%">
                <col width="21%">
            </colgroup>
            <tr>
                <th>№</th>
                <td><span class="dir-datafield" id="dir_num"></span></td>
                <th>Финанс.</th>
                <td><span class="dir-datafield" id="fin_source"></span><span class="show-rmis">внеш.орг</span></td>
            </tr>
            <tr>
                <th>Пациент</th>
                <td colspan="3"><span class="dir-datafield" id="dir_client_fio"></span></td>
            </tr>
            <tr>
                <th>Пол</th>
                <td><span class="dir-datafield" id="client_sex"></span></td>
                <th>Возраст</th>
                <td><span class="dir-datafield" id="client_vozrast"></span></td>
            </tr>
            <tr class="show-history" style="display: none">
                <th>Карта</th>
                <td><span class="dir-datafield" id="client_cardnum"></span></td>
                <th>Истор.</th>
                <td title="Номер истории"><span class="dir-datafield" id="client_hisnum"></span></td>
            </tr>
            <tr class="show-nohistory">
                <th>Карта</th>
                <td colspan="3"><span class="dir-datafield" id="client_cardnum_nohistory"></span></td>
            </tr>
            <tr title="Лечащий врач" class="show-lv">
                <th>Леч. врач</th>
                <td colspan="3"><span class="dir-datafield" id="directioner"></span></td>
            </tr>
            <tr class="show-lv">
                <th>Отделение</th>
                <td colspan="3"><span class="dir-datafield" id="otd"></span></td>
            </tr>
            <tr class="show-rmis">
                <th style="font-size: 90%">Организация</th>
                <td colspan="3"><span class="dir-datafield" id="imported_org"></span></td>
            </tr>
        </table>
        <div class="fastlinks" id="loaded-buttons" style="min-height: 20px">
            <div style="display: flex;justify-content: space-between;flex-direction: row-reverse">
                <a href="#" onclick="reload_fast(true);return false;">Перезагрузить данные</a>
                <a href="#" onclick="open_fill_form();return false;">Заполнить поля</a>
            </div>
        </div>
        <div id="issledovaniya-scroll">
            <div class="not-loaded" style="padding: 20px;color: #9d9d9d;text-align: center">Ничего не загружено</div>
            <div id="empty-dir-for-lab" style="padding: 20px;color: #9d9d9d;text-align: left;display: none">
                Нет исследований для выбранной лаборатории.<br/><br/>
                Назначения в направлении:
                <ul></ul>
            </div>
            <div class="alert alert-warning data-dir-changed" style="display: none;">
                Некоторые результаты в направлении были изменены!<br/>
                <a href="#" onclick="reload_fast(true);return false;" class="alert-link">Нажмите здесь для перезагрузки
                    данных</a>
            </div>
            <ul id="issledovaniya"></ul>
        </div>
    </div>
    <div class="col-md-4 col-lg-6" id="form-scroll" style="margin-top: -10px">
        <div class="alert alert-warning data-research-confirmed data-research-changed" style="display: none;">
            <div class="data-research-changed" style="display: none;">Результат изменён.</div>
            <div class="data-research-confirmed" style="display: none;">Результат изменил статус подтверждения.</div>
        </div>
        <div class="alert alert-warning data-research-confirmed data-research-changed" style="display: none;">
            <a href="#" onclick="reload_fast(true);return false;" class="alert-link">Нажмите
                здесь для перезагрузки данных</a></div>
        <div class="not-loaded" style="padding: 20px;color: #9d9d9d;text-align: center">Ничего не загружено</div>
        <div id="result-form"></div>
    </div>
    <div class="modal fade" id="list-modal">
        <div class="modal-dialog" style="width: 64%;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Создание листа исполения</h4>
                </div>
                <div class="modal-body">
                    Дата приёма материала:
                    <br/>
                    <div class="input-daterange input-group" id="datepicker" style="margin-top: 2px">
                        <input type="text" class="input-sm form-control no-context" name="date-start"/>
                        <span class="input-group-addon" style="background-color: #fff;color: #000">&mdash;</span>
                        <input type="text" class="input-sm form-control no-context" name="date-end"/>
                    </div>
                    <div style="height: 400px">
                        <div id="table-researches" class="table-researches"></div>
                    </div>
                    <br/>
                    <hr/>
                    <div class="row" style="text-align: center;width: 100%">
                        <div class="col-xs-2"></div>
                        <div class="col-xs-8" style="margin: 0 auto">
                            <div class="row">
                                <div class="col-xs-6">
                                    <button type="button" class="btn btn-primary-nb" style="margin-bottom: 10px"
                                            onclick="$('#table-researches input[type=checkbox]').prop('checked', true);sync_checks();return false;">
                                        Выбрать всe
                                    </button>
                                </div>
                                <div class="col-xs-6">
                                    <button type="button" class="btn btn-primary-nb" style="margin-bottom: 10px"
                                            onclick="$('#table-researches input[type=checkbox]').prop('checked', false);sync_checks();return false;">
                                        Снять всe
                                    </button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary-nb" style="margin-bottom: 10px"
                                    onclick="createlist(3);return false;">
                                Создать таблицу исполнения (по не подтверждённым)
                            </button>
                            <button type="button" class="btn btn-primary-nb" style="margin-bottom: 10px"
                                    onclick="createlist(1);return false;">Создать лист по выбранному периоду
                            </button>
                            <button type="button" class="btn btn-primary-nb" onclick="createlist(2);return false;">
                                Создать лист по отложенным
                            </button>
                        </div>
                        <div class="col-xs-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="journal-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Журнал</h4>
                </div>
                <div class="modal-body">
                    <label><span style="display: inline-block;">Дата подтверждения результата:</span> <span
                            style="display: inline-block;"><input type="text" class="form-control no-context"
                                                                  style="display: inline-block"
                                                                  name="date-confirm"/></span></label>
                    <hr/>
                    <div class="row">
                        <div class="col-xs-2"></div>
                        <div class="col-xs-8">
                            <label>
                                Источник финансирования:
                                <select class="select-b" data-width="100%" multiple data-actions-box="true" id="ist_f">
                                    {% for v in ist_f %}
                                        <option value="{{ v.pk }}">{{ v.base.title }} - {{ v.title }}</option>
                                    {% endfor %}
                                </select>
                            </label>
                        </div>
                        <div class="col-xs-2"></div>
                    </div>
                    <br/>
                    <div class="row">
                        <div class="col-xs-2"></div>
                        <div class="col-xs-8">
                            <label>
                                Группа исследований для журнала-списка:
                                <select class="select-b" data-width="100%" id="select-journal-group">
                                    <option value="-2" selected>Все исследования</option>
                                    <option value="-1">Без группы</option>{% for x in groups %}
                                    <option value="{{ x.pk }}">{{ x.title }}</option>{% endfor %}
                                </select>
                            </label>
                        </div>
                        <div class="col-xs-2"></div>
                    </div>
                    <br/>
                    <div class="row" style="text-align: center">
                        <div class="col-xs-2"></div>
                        <div class="col-xs-8" style="margin: 0 auto">
                            <button type="button" class="btn btn-primary-nb" style="margin-bottom: 10px"
                                    onclick="createjournal();return false;">Создать журнал-список
                            </button>
                        </div>
                        <div class="col-xs-2"></div>
                    </div>
                    <div class="row" style="text-align: center">
                        <div class="col-xs-2"></div>
                        <div class="col-xs-8" style="margin: 0 auto">
                            <button type="button" class="btn btn-primary-nb" style="margin-bottom: 10px"
                                    onclick="createjournaltable();return false;">Создать журнал-таблицу
                            </button>
                        </div>
                        <div class="col-xs-2"></div>
                    </div>
                    <div class="row" style="text-align: center">
                        <div class="col-xs-2"></div>
                        <div class="col-xs-8" style="margin: 0 auto">
                            <button type="button" class="btn btn-primary-nb" style="margin-bottom: 10px"
                                    onclick="createjournalcodes();return false;">Создать журнал-список с кодами
                            </button>
                        </div>
                        <div class="col-xs-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="results-day-modal">
        <div class="modal-dialog" style="width: 64%;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Печать результатов за день</h4>
                </div>
                <div class="modal-body">
                    <label><span style="display: inline-block;">Дата подтверждения результата:</span> <span
                            style="display: inline-block;"><input type="text" class="form-control no-context"
                                                                  style="display: inline-block" name="dateday-confirm"/></span></label>
                    <div style="height: 400px">
                        <div id="dayprint-table-researches" class="table-researches"></div>
                    </div>
                    <br/>
                    <hr/>
                    <div class="row" style="text-align: center;width: 100%">
                        <div class="col-xs-2"></div>
                        <div class="col-xs-8" style="margin: 0 auto">
                            <div class="row">
                                <div class="col-xs-6">
                                    <button type="button" class="btn btn-primary-nb" style="margin-bottom: 10px"
                                            onclick="$('#dayprint-table-researches input[type=checkbox]').prop('checked', true);sync_checks();return false;">
                                        Выбрать всe
                                    </button>
                                </div>
                                <div class="col-xs-6">
                                    <button type="button" class="btn btn-primary-nb" style="margin-bottom: 10px"
                                            onclick="$('#dayprint-table-researches input[type=checkbox]').prop('checked', false);sync_checks();return false;">
                                        Снять всe
                                    </button>
                                </div>
                            </div>
                            <br/>
                            <div class="row">
                                <div class="col-xs-6">
                                    <select class="selectpicker" data-width="100%" style="width: 100%"
                                            id="print-results-otd">
                                        <option value="-1">Все отделения</option>
                                        {% for v in podrazdeleniya %}
                                            <option value='{{ v.pk }}'>{{ v.title }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-xs-6">
                                    <button type="button" class="btn btn-primary-nb" style="margin-bottom: 10px"
                                            onclick="dayprint_do();return false;">Печать результатов за выбранную дату
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
    <div id="dataConfirmModal" class="modal fade" role="dialog" aria-labelledby="dataConfirmLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="dataConfirmLabel">Некоторые исследования были сохранены другим пользователем</h3></div>
                <div class="modal-body">Вы уверены, что хотите подтвердить всё?</div>
                <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">Отмена</button>
                    <a class="btn btn-primary" id="dataConfirmOK">Подтвердить</a></div>
            </div>
        </div>
    </div>
    <div id="fillform-modal" class="modal fade" role="dialog" aria-labelledby="fillform-modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="fillform-modalLabel">Заполнение полей</h3></div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-xs-6">
                            <label style="width: 100%">
                                Ёмкость:<br/><select class="form-control" style="width: 100%"
                                                     id="fillform-tubes"></select>
                            </label>
                        </div>
                        <div class="col-xs-6">
                            <label style="width: 100%">
                                Текст заполнения:<br/>
                                <input type="text" style="width: 100%" class="form-control" id="fillform-text"/>
                            </label>
                        </div>
                    </div>
                    <label><input type="radio" name="fillform-type" value="empty" checked/> Только пустые</label><br/>
                    <label><input type="radio" name="fillform-type" value="all"/> Все</label>
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <div class="col-xs-6">
                            <button class="btn btn-primary-nb" id="fill-hide" data-dismiss="modal" aria-hidden="true">
                                Отмена
                            </button>
                        </div>
                        <div class="col-xs-6">
                            <button class="btn btn-primary-nb" onclick="do_fill();" id="fillform-ok">Подтвердить
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="refsettings-modal" class="modal fade" role="dialog" aria-labelledby="refsettings-modalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 id="refsettings-modalLabel">Настройка референсов</h4>
                </div>
                <div class="modal-body">

                </div>
                <div class="modal-footer">
                    <div class="row">
                        <div class="col-xs-6">
                        </div>
                        <div class="col-xs-6">
                            <button class="btn btn-primary-nb" data-dismiss="modal" aria-hidden="true"
                                    onclick="apply_refs();">
                                Ок
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block head_cn %}
    <style>
        .isnorm_normal input[type=text] {
        }

        .isnorm_maybe input[type=text] {
            border-color: darkgoldenrod;
            box-shadow: 0 0 4px darkgoldenrod;
        }

        .isnorm_not_normal input[type=text] {
            border-color: darkred;
            box-shadow: 0 0 4px darkred;
        }

        .w50 {
            width: 70px;
            display: inline-block;
            margin-left: 5px;
        }

        th small {

        }

        label {
            cursor: pointer !important;
        }

        .floatThead th {
            background-color: #fff;
        }

        .status {
            float: right;
            display: inline-block;
            vertical-align: top;
            font-size: 11px;
            text-align: right;
            padding-bottom: 3px;
            position: absolute;
            right: 0;
            top: -3px;
        }

        .active .status {
            /*font-weight: 600;*/
        }

        .status-n {
            color: #CF3A24;
            font-weight: bold;
        }

        .status-s {
            color: #4B77BE;
        }

        .status-c {
            color: #049372
        }

        .status-o {
            color: #F7CA18;
            font-weight: bold;
        }

        .awesome.ok {
            background-color: #434A54;
            color: #fff
        }

        #dirs-list {
            padding-left: 0;
            padding-right: 11px;
        }

        #tubes-list {
            padding-left: 0;
            padding-right: 11px;
        }

        #dirs-list tbody, #tubes-list tbody {
            min-height: 100px;
        }

        #dirs-list td, #tubes-list td, #dirs-list th, #tubes-list th {
            padding: 6px;
        }

        .active {
            background-color: #6C7A89 !important;
            color: #fff !important;
        }

        li.active {
            background-color: #fff !important;
            color: #000 !important;
            padding-left: 6px !important;
        }

        .select-dir.active td, .select-tube.active td:not(.tube-color-td) {
            background-color: #6C7A89 !important;
            color: #fff !important;
        }

        .select-dir td, .select-tube {
            background-color: #fff;
        }

        .select-tube, .select-dir {
            cursor: pointer;
        }

        .highlight, .select-tube:hover, .select-dir:hover {
        }

        .select-tube:hover, .select-dir:hover .num {
            background-color: #FAFAFA;
            z-index: 10;
        }

        .select-tube, .select-dir .num {
            background-color: #FFF;
            z-index: 1;
        }

        .st .tube-color-td {
            width: 10%;
            padding: 0 !important;
        }

        .st td:not(.tube-color-td) {
            width: 45%;
        }

        html, body {
            overflow: hidden;
            height: 100%
        }

        body {
            margin: 0;
            padding: 0;
        }

        #lists {
            margin-right: -10px;
        }

        #tubes-list, #dirs-list, #issledovaniya-scroll, #result-jade-form {
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #issledovaniya-scroll, #result-jade-form {
            padding-right: 15px;
        }

        #result-jade-form > table {
            width: 100% !important;
        }

        #issledovaniya {
            margin: 0;
            padding: 0;
        }

        #issledovaniya li {
            list-style: none;
            cursor: pointer;
            margin: 3px;
            background-color: #f8fcfd;
            border: 1px solid #ECF0F1;
            border-left-width: 3px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            transition: left .15s linear;
            position: relative;
            left: 3px;
            padding: 6px 6px 6px 9px;
        }

        #issledovaniya li small {
            color: rgba(0, 0, 0, .5);
            font-size: 8pt;
        }

        #issledovaniya li:hover {
            background-color: #eef1f5;
        }

        #issledovaniya li .hiddenlinks {
            opacity: 0;
            transition: .1s linear;
        }

        #issledovaniya li:hover .hiddenlinks {
            opacity: 1;
        }

        #issledovaniya li:hover small {
            color: #000
        }

        #dir_info {
            table-layout: fixed;
            font-size: 12px;
        }

        #dir_info td, #dir_info th {
            padding: 3px;
            word-wrap: break-word
        }

        .center {
            text-align: center;
        }

        .tt-hint {
            display: none !important;
        }

        span.twitter-typeahead {
            width: 100%;
        }

        .input-group span.twitter-typeahead {
            display: block !important;
        }

        .input-group span.twitter-typeahead .tt-dropdown-menu {
            top: 32px !important;
        }

        .input-group.input-group-lg span.twitter-typeahead .tt-dropdown-menu {
            top: 44px !important;
        }

        .input-group.input-group-sm span.twitter-typeahead .tt-dropdown-menu {
            top: 28px !important;
        }

        .fastlinks a {
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .fastlinks a:nth-child(1) {
            min-width: 125px;
        }

        .fastlinks a:nth-child(2) {
            min-width: 60px;
        }

        .fastlinks {
            margin-top: -13px;
            margin-bottom: 5px;
        }

        .fastlinks:not(#loaded-buttons):not(.hiddenlinks) {
            display: flex;
            white-space: nowrap;
        }

        #issledovaniya .fastlinks {
            position: absolute;
            right: 6px;
            bottom: -1px;
            margin: 0;
        }

        .hiddenlinks {
            font-weight: 400;
            margin-top: 3px;
            margin-bottom: 2px;
            padding-bottom: 3px;
        }

        .hiddenlinks a {
            font-size: 9pt;
            margin-right: -5px;
            padding: 2px !important;
            white-space: nowrap;
        }

        .m2 {

        }

        .datepicker {
            z-index: 10005 !important;
        }

        .save-other {
            font-weight: 500;
            font-size: 10pt;
            color: #E08A1E
        }

        .no-tube {
            font-size: 10pt;
            font-weight: bold;
            color: #e74c3c
        }

        .rd-cont {
            padding-left: 2px;
            padding-right: 2px;
            text-align: center;
        }

        .rd-row input[type="radio"]:checked + label {
            color: #049372 !important;
            background-color: #ECF0F1;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
        }

        .rd-row input[type="radio"] {
            display: none;
        }

        .rd-cont {
            padding-left: 2px;
            padding-right: 2px;
            text-align: center;
        }

        .rd-cont label {
            display: block;
            cursor: pointer;
            padding-top: 2px;
            padding-bottom: 3px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            transition: all 0.11s ease-in-out;
        }

        .rd-cont label:hover {
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.19), 0 6px 6px rgba(0, 0, 0, 0.23);
            background-color: #fafafa;
        }

        .rd-row {
            margin: 0;
        }

        .labtitle {
            font-weight: normal;
            font-size: 14px;
            display: block;
            min-height: 100%;
            height: 100%;
            margin: 0;
        }

        .form-control.result-enter,
        .subgroup-title {
            padding-top: 2px;
            padding-bottom: 2px;
            height: 30px;
            padding-left: 5px;
        }

        .val {
            position: relative;
        }

        .val .unit {
            color: #888;
            top: 1px;
            right: 2px;
            display: block;
        }

        .val .unit:not(:empty) {
            z-index: 1;
            word-break: keep-all;
            white-space: nowrap;
            height: 20px;
            margin-top: -24px;
            padding-bottom: 4px;
            padding-right: 5px;
            float: right;
            text-align: right;
            box-sizing: border-box;
            overflow: hidden;
            font-size: 12px;
            max-width: 64px;
        }

        .val .result-enter[unit]:not([unit=""]) {
            padding-right: calc(64px / 9 * var(--x) + 7px);
            top: 0;
            left: 0;
            display: block;
        }

        [data-x="1"] {
            --x: 1;
        }

        [data-x="2"] {
            --x: 2;
        }

        [data-x="3"] {
            --x: 3;
        }

        [data-x="4"] {
            --x: 4;
        }

        [data-x="5"] {
            --x: 5;
        }

        [data-x="6"] {
            --x: 6;
        }

        [data-x="7"] {
            --x: 7;
        }

        [data-x="8"] {
            --x: 8;
        }

        [data-x="9"] {
            --x: 9;
        }

        .btn25 {
            padding-top: 1px;
            padding-bottom: 1px;
            height: 25px;
        }

        .btn30 {
            padding-top: 3px;
            padding-bottom: 2px;
            height: 30px;
        }

        .tb-group-1 {
            border-left: 3px #16a085 solid !important;
        }

        .tb-group-2 {
            border-left: 3px #8e44ad solid !important;
        }

        .tb-group-3 {
            border-left: 3px #2e8dcd solid !important;
        }

        .tb-group-4 {
            border-left: 3px #2c3e50 solid !important;
        }

        .tb-group-5 {
            border-left: 3px #27ae60 solid !important;
        }

        .tb-group-6 {
            border-left: 3px #f1c40f solid !important;
        }

        .tb-group-7 {
            border-left: 3px #e67e22 solid !important;
        }

        .tb-group-8 {
            border-left: 3px #e74c3c solid !important;
        }

        /*.select-tube {
            transition: .3s linear all;
        }*/

        .select-tube.active {
            border-left-width: 8px !important;
        }

        li.tb-group-1.active {
            border-left-width: 6px !important;
            border-top: 1px solid #16a085 !important;
            border-bottom: 1px solid #16a085 !important;
        }

        li.tb-group-1.active:not(.issledovaniya-isnorm-not_normal):not(.issledovaniya-isnorm-maybe) {
            border-right: 1px solid #16a085 !important;
        }

        li.tb-group-2.active {
            border-left-width: 6px !important;
            border-top: 1px solid #8e44ad !important;
            border-bottom: 1px solid #8e44ad !important;
        }

        li.tb-group-2.active:not(.issledovaniya-isnorm-not_normal):not(.issledovaniya-isnorm-maybe) {
            border-right: 1px solid #8e44ad !important;
        }

        li.tb-group-3.active {
            border-left-width: 6px !important;
            border-top: 1px solid #2e8dcd !important;
            border-bottom: 1px solid #2e8dcd !important;
        }

        li.tb-group-3.active:not(.issledovaniya-isnorm-not_normal):not(.issledovaniya-isnorm-maybe) {
            border-right: 1px solid #2e8dcd !important;
        }

        li.tb-group-4.active {
            border-left-width: 6px !important;
            border-top: 1px solid #2c3e50 !important;
            border-bottom: 1px solid #2c3e50 !important;
        }

        li.tb-group-4.active:not(.issledovaniya-isnorm-not_normal):not(.issledovaniya-isnorm-maybe) {
            border-right: 1px solid #2c3e50 !important;
        }

        li.tb-group-5.active {
            border-left-width: 6px !important;
            border-top: 1px solid #27ae60 !important;
            border-bottom: 1px solid #27ae60 !important;
        }

        li.tb-group-5.active:not(.issledovaniya-isnorm-not_normal):not(.issledovaniya-isnorm-maybe) {
            border-right: 1px solid #27ae60 !important;
        }

        li.tb-group-6.active {
            border-left-width: 6px !important;
            border-top: 1px solid #f1c40f !important;
            border-bottom: 1px solid #f1c40f !important;
        }

        li.tb-group-6.active:not(.issledovaniya-isnorm-not_normal):not(.issledovaniya-isnorm-maybe) {
            border-right: 1px solid #f1c40f !important;
        }

        li.tb-group-7.active {
            border-left-width: 6px !important;
            border-top: 1px solid #e67e22 !important;
            border-bottom: 1px solid #e67e22 !important;
        }

        li.tb-group-7.active:not(.issledovaniya-isnorm-not_normal):not(.issledovaniya-isnorm-maybe) {
            border-right: 1px solid #e67e22 !important;
        }

        li.tb-group-8.active {
            border-left-width: 6px !important;
            border-top: 1px solid #e74c3c !important;
            border-bottom: 1px solid #e74c3c !important;
        }

        li.tb-group-8.active:not(.issledovaniya-isnorm-not_normal):not(.issledovaniya-isnorm-maybe) {
            border-right: 1px solid #e74c3c !important;
        }

        #search-field:focus::-webkit-input-placeholder {
            color: transparent;
        }

        #search-field:focus:-moz-placeholder {
            color: transparent;
        }

        #search-field:focus::-moz-placeholder {
            color: transparent;
        }

        #search-field:focus:-ms-input-placeholder {
            color: transparent;
        }

        #result-form th {
            padding: 2px 2px 2px 8px;
        }

        .ref {
            padding: 0 !important;
            position: relative;
            z-index: 0;
        }

        .ref:before {
            background-color: #ddd;
            content: "";
            display: block;
            width: 1px;
            height: 100%;
            position: absolute;
            z-index: -1;
            top: 0;
            left: calc(50% - 1px);
        }

        .ref table {
            width: 100%;
            background: transparent !important;
            table-layout: fixed;
        }

        .ref table td, .ref table th {
            border: 1px solid #ddd;
            background: transparent;
        }

        .ref table tr {
            background: transparent;
        }

        .ref table td {
            width: 50%;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ref table tr:first-child th {
            border-top: 0 !important;
        }

        .ref table tr:first-child td {
            border-top: 0 !important;
        }

        .ref table tr:last-child th {
            border-bottom: 0 !important;
        }

        .ref table tr:last-child td {
            border-bottom: 0 !important;
        }

        .ref table tr td {
            border-left: 0 !important;
            border-right: 0 !important;
            line-height: 1.2;
        }

        #issledovaniya li:not(.issledovaniya-isnorm-maybe):not(.issledovaniya-isnorm-not_normal) {
            padding-right: 8px;
        }

        .issledovaniya-isnorm-maybe, .issledovaniya-isnorm-not_normal {
            border-right-width: 3px !important;
        }

        .issledovaniya-isnorm-not_normal {
            border-right-color: #E68364 !important;
        }

        .issledovaniya-isnorm-maybe {
            border-right-color: #F5D76E !important;
        }

        .circle {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-bottom: 3px;
        }

        :not(.active) .circle {
            box-shadow: 0 0 2px #6C7A89;
        }

        .ref sup {
            top: 0
        }

        .mt5 {
            margin-top: 5px;
        }

        .no_units_and_ref #ref-settings-btn {
            display: none;
        }

        .no_units_and_ref #save-btn {
            border-top-left-radius: 3px !important;
            border-bottom-left-radius: 3px !important;
        }

        .no_units_and_ref table tr > th:nth-child(3), .no_units_and_ref table tr > th:nth-child(4),
        .no_units_and_ref table tr > td:nth-child(3), .no_units_and_ref table tr > td:nth-child(4) {
            display: none;
        }

        .form-control.result-enter[readonly] {
            background-color: #fff;
        }
    </style>
{% endblock %}

{% block scripts %}
    {% load static %}
    <script src="{% static 'js/runtime.js' %}"></script>
    <script src="{% static 'js/jade.min.js' %}"></script>
    <script src="{% static 'js/ajaxq.js' %}"></script>
    <script src="{% static 'js/socket.io.js' %}"></script>
    <script>

        $('#empty-dir-for-lab').hide()

        let firstrun = true
        let first_resize = true
        let list_reload = false
        let su = false
        let lockdeff = false

        let type = 0
        let cached_templates = {}
        let nn = 0

        let loaded_research = -1
        let datatype = -1
        let loaded_fractions = {}
        let researches_cache = {}
        let rendered_form_cache = {}
        let laborants = []
        let isDoc = false

        let dir_active = -1
        let tubes_active = []
        let type_active = -1

        let dir_data = {}

        let loadingtable = '<tr class="isloading-wrapper %wrapper%"><td>%text%</td></tr>'
        let lab_pk = {{ lab.pk }};
        let user_pk = {{ user.doctorprofile.pk }};

        let entityMap = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            '\'': '&#39;',
            '/': '&#x2F;',
            '`': '&#x60;',
            '=': '&#x3D;'
        }
        let mapEntity = Object.keys(entityMap).reduce(function (obj, key) {
            obj[entityMap[key]] = key
            return obj
        }, {})

        function escapeHtml(string) {
            return String(string).replace(/[&<>"'`=\/]/g, function (s) {
                return entityMap[s]
            })
        }

        function deescapeHtml(string) {
            return String(string).replace(new RegExp(`(${Object.keys(mapEntity).join('|')})`), function (s) {
                return mapEntity[s]
            })
        }

        let statuses = {'n': 'Не обработан', 's': 'Обработан', 'c': 'Подтверждён', 'o': 'Отложен'} //= {"n": "Н", "s": "О", "c": "П", "o": "ОТ"};
        let statuses_titles = {
            'n': 'Не обработан',
            's': 'Обработан (сохранен, ожидает подтверждения)',
            'c': 'Подтверждён',
            'o': 'Отложен'
        }

        let iss_pks = []
        let has_o = false
        let iss_isnorm = {'unknown': '', 'normal': 'Норма', 'not_normal': 'Не норма', 'maybe': 'Не удалось обработать'}

        let substringMatcher = function (strs) {
            return function findMatches(q, cb) {
                let matches, substrRegex
                matches = []
                substrRegex = new RegExp(q, 'i')
                $.each(strs, function (i, str) {
                    if (substrRegex.test(str)) {
                        matches.push(str)
                    }
                })

                cb(matches)
            }
        }

        let fill_researches = {}
        let queue_fill = []
        let request = ''

        let socket = null

        function emit_event(name, data) {
            if (!socket)
                return
            socket.emit(name, data)
        }

        $(document).ready(function () {
            if ({{ ws_enabled }}) {
                try {
                    socket = io.connect({{ ws_url|safe }}, {
                        reconnection: true,
                        reconnectionDelay: 1000,
                        reconnectionDelayMax: 5000,
                        reconnectionAttempts: 10
                    })

                    socket.on('results_save', (data) => {
                        if (parseInt(data.pk) === loaded_research) {
                            $('.data-research-changed').show()
                            resize()
                        } else if (parseInt(data.dir) === dir_active) {
                            $('.data-dir-changed').show()
                        }
                    })

                    socket.on('result_confirm', (data) => {
                        if (parseInt(data.pk) === loaded_research) {
                            $('.data-research-confirmed').show()
                            $('#ref-settings-btn').prop('disabled', true)
                            $('#save-btn').prop('disabled', true)
                            $('#clear-all-btn').prop('disabled', true)
                            $('#confirm-btn').prop('disabled', true)
                            $('#confirm-andsave-btn').prop('disabled', true)
                            resize()
                        } else if (parseInt(data.dir) === dir_active) {
                            $('.data-dir-changed').show()
                        }
                    })
                } catch (e) {
                }
            }
            $('.show-rmis').hide()
            {% if request.user.is_superuser %}su = true{% endif %}
            $('#result-print').prop('disabled', true)
            $('#result-confirm').prop('disabled', true)
            $(window).resize(function () {
                resize()
            })
            decsl()
            $.ajax({
                url: '/api/laborants',
                dataType: 'json'
            }).done(function ({data = [], doc}) {
                laborants = data
                isDoc = doc || su
            }).always(dechl)
            nn++
            $.ajax({ // AJAX запрос
                url: '/directory/researches/list?lab_id=' + lab_pk,// Установка адреса и параметров запроса
                dataType: 'json'
            }).done(function (data) {
                let vv = []
                for (let v of data) {
                    vv.push(v.id)
                }
                nn++
                $.ajaxq('precache', {
                    url: '/researches/get/one',
                    method: 'GET',
                    cache: false,
                    data: {
                        id: JSON.stringify(vv),
                        isresearch: true,
                        cached: false,
                        multi: true
                    }
                }).done(function (data2) {
                    for (let v of data2) {
                        researches_cache[v.i] = {
                            title: v.title,
                            fractions: v.fractions,
                            can_comment: v.can_comment,
                            no_units_and_ref: v.no_units_and_ref,
                            co_executor_mode: v.co_executor_mode,
                            co_executor_title: v.co_executor_title,
                        }
                    }
                }).always(dechl)

                for (let i = 0; i < 4; i++) {
                    nn++;
                    (function (i) {
                        $.ajaxq('precache', {
                            url: `{% static 'templates' %}/${i}.jade?1`,
                            type: 'text',
                            cache: false,
                            method: 'GET'
                        }).done(function (data) {
                            cached_templates[i] = data
                        }).always(dechl)
                    })(i)
                }
            }).always(dechl)

            $(document).on('click', '.select-tube', function () {
                fast_search($(this, '.num').attr('tube'))
                $('#option1').attr('checked', 'checked')
                $('#option2').removeAttr('checked')
                $('#option1').parent('.btn').addClass('active')
                $('#option2').parent('.btn').removeClass('active')
                type = 0
                load_d_fast()
            })

            $(document).on('click', '.select-dir', function () {
                fast_search($(this).attr('direction'))
                $('#option1').removeAttr('checked')
                $('#option2').attr('checked', 'checked')
                $('#option1').parent('.btn').removeClass('active')
                $('#option2').parent('.btn').addClass('active')
                type = 1
                load_d_fast()
            })

            $('#search-field').bind('keydown', 'return', function () {
                load_d_fast()
            })
            $('body').on('keyup', ':not(.row-container) .result-enter', function (e) {
                if (e.which === 13) {
                    let index = $('.result-enter:not(.tt-hint)').index(this) + 1
                    if ($('.result-enter:not(.tt-hint)').eq(index).length)
                        $('.result-enter:not(.tt-hint)').eq(index).focus()
                    else
                        save()
                }
            })

            $('[name=\'date-start\'],[name=\'date-end\'],[name=\'datemain-start\'],[name=\'datemain-end\'],[name=date-confirm],[name=dateday-confirm]').val(getFormattedDate(today))
            $('#datepicker, #datepickermain,[name=date-confirm],[name=dateday-confirm]').datepicker({
                format: 'dd.mm.yyyy',
                todayBtn: 'linked',
                language: 'ru',
                autoclose: true,
                todayHighlight: true
            })
            $('.context-st').show()
            resize()

            load_tubes_and_dirs()

            $('body').on('change', '.table-researches .btn input', sync_checks)
            $('#loaded-buttons a').fadeOut(100)

        })

        function sync_checks() {
            $('.btn').removeClass('active-b')
            let elements = document.querySelectorAll('input[name=\'sel\']:checked')
            Array.prototype.forEach.call(elements, function (el) {
                $(el).parent().addClass('active-b')
            })
        }

        function tgfreeze(th) {
            $('[name=\'datemain-start\'],[name=\'datemain-end\']').prop('disabled', $(th).prop('checked'))
        }

        function load_d_fast() {
            type = $('label.btn.active input').val()
            load_data($('#search-field').val(), type)
        }

        function reload_fast(sync_all_scroll) {
            let s = !!sync_all_scroll

            if (loaded_research < 0 && request !== '') return

            load_data(request, type, false, false, s)

            //load_form(loaded_research);
        }

        function get_age(s_age) {
            return parseInt(s_age.split(' ')[0])
        }

        function sync_active(resync) {
            let rs = !!resync
            $('.select-dir.active, .select-tube.active').removeClass('active')
            if (dir_active != -1 && $(`[direction='${dir_active}']`).length) {
                if (type_active == 0 || rs) {
                    $('#dirs-list').scrollTo($(`.select-dir[direction='${dir_active}']`).addClass(type_active === 0 ? 'active' : ''), 0, {offset: -35})
                }
                if (type_active == 1 || rs) {
                    $(`[direction='${dir_active}']`).addClass(type_active == 1 ? 'active' : '')
                    $('#tubes-list').scrollTo($(`.select-tube[direction='${dir_active}']`), 0, {offset: -35})
                }
            }
            for (let tube of tubes_active) {
                $(`.select-tube[tube='${tube.pk}']`).addClass(tube.group)
                if (type_active == 0) {
                    $(`.select-tube[tube='${tube.pk}']`).addClass('active')
                }
            }
        }

        function load_data(id, type, select_el, noclear, s) {

            tubes_active = []
            dir_active = -1
            type_active = type

            sl()
            iss_pks = []
            $('#search-field').attr('placeholder', '')

            $('#loaded-buttons a').fadeOut(100)
            $('.dir-datafield').fadeOut(100)
            $('.show-lv').show()
            $('.show-rmis').hide()
            $.ajax({
                url: '/directions/get/issledovaniya',
                type: 'json',
                method: 'GET',
                data: {id: id.trim(), type: type, lab_pk: lab_pk}
            }).done(function (data) {
                hl()
                if (data.msg) {
                    alert(data.msg)
                }
                if (!data.ok) {
                    $('#search-field').parent().addClass('has-error')
                    $('#search-field').tooltipster({
                        content: 'Не найдено',
                        //position: "bottom",
                        theme: 'tooltipster-shadow'
                    })
                    $('#search-field').tooltipster('show')
                    if (loaded_research >= 0) {

                        $('#loaded-buttons a').fadeIn(100)
                        $('.dir-datafield').fadeIn(100)
                    }
                    //load_tubes_and_dirs();
                    return
                }
                $('#result-print').attr('disabled', 1)
                $('#result-confirm').attr('disabled', 1)

                if (!noclear) {
                    $('#search-field').val('')
                }

                $('.has-error').removeClass('has-error')
                try {
                    $('#search-field').tooltipster('destroy')
                } catch (e) {

                }
                request = id
                dir_data = data
                $('#issledovaniya').isLoading('hide')
                $('.not-loaded').hide()
                $('#empty-dir-for-lab').hide()
                $('#empty-dir-for-lab ul').html('')
                $('#issledovaniya').show()
                $('#result-form').empty()
                $('#issledovaniya').empty()
                $('#dir_num').html(`<a href='/directions/pdf?napr_id=[${data.napr_pk}]' target='_blank'>${data.napr_pk}</a>`)
                $('#dir_client_fio').html(data.client_fio)
                $('#directioner').html(data.directioner)
                $('#client_vozrast').html(data.client_vozrast)
                $('#client_sex').html(data.client_sex)

                if (data.client_hisnum === '' || !data.client_hisnum) {
                    $('.show-history').hide()
                    $('.show-nohistory').show()
                    $('#client_cardnum_nohistory').html(data.client_cardnum)
                } else {
                    $('.show-history').show()
                    $('.show-nohistory').hide()
                    $('#client_cardnum').html(data.client_cardnum)
                    $('#client_hisnum').html(data.client_hisnum)
                }

                $('#fin_source').html(data.fin_source)
                $('#otd').html(data.otd)
                if (data.imported_from_rmis) {
                    $('.show-lv').hide()
                    $('.show-rmis').show()
                }
                $('#imported_org').html(data.imported_org)
                $('.dir-datafield').fadeIn(100)
                let status = 'n', all_saved = false, firstch = true, has_n = false, all_o = true
                has_o = false
                $('.select-tube').removeClass(function (index, css) {
                    return (css.match(/(^|\s)tb-group-\d+/g) || []).join(' ')
                })

                const tmp_types = {'1': 'направление', '0': 'ёмкость'}
                $('#search-field').attr('placeholder', `Загружено: ${tmp_types[type + '']} ${id}`)

                dir_active = data.napr_pk
                let pks = []
                if (data.issledovaniya.length === 0) {
                    $('#empty-dir-for-lab').show()
                    const q = encodeURIComponent(JSON.stringify(data.q))
                    if ('labs_objects' in data) {
                        for (const p of data.labs_objects) {
                            if (p.islab) {
                                $('#empty-dir-for-lab ul').append(`<li><a href='/results/enter?lab_pk=${p.pk}#q:${q}'>Перейти в ${p.title}</a></li>`)
                            } else {
                                $('#empty-dir-for-lab ul').append(`<li>${p.title}</li>`)
                            }
                        }
                    }
                }
                $.each(data.issledovaniya, function (k, v) {
                    if (v.saved && !v.confirmed) status = 's'
                    else if (v.saved && v.confirmed) status = 'c'
                    else if (!v.deff) status = 'n'
                    else status = 'o'


                    if (status === 's') {
                        if (firstch && !all_saved && !has_n) {
                            all_saved = firstch = true
                        }
                    } else if (status === 'n') {
                        all_saved = false
                        has_n = true
                    }
                    let deffc, sv
                    deffc = sv = ''
                    if (status !== 'c') {
                        if (v.deff === false) {
                            iss_pks.push(v.pk)
                            deffc = `<div class='fastlinks hiddenlinks'><a href='#' onclick='deff(true, ${v.pk});return false;'>отложить</a>`
                            all_o = false
                        } else {
                            deffc = `<div class='fastlinks hiddenlinks'><a href='#' onclick='deff(false, ${v.pk});return false;'>отм. отложить</a>`
                            status = 'o'
                        }
                        if (v.current_doc_save === 0) {
                            sv = `<br/><span class='save-other'>сохранил: ${v.doc_save_fio}</span>`
                            if (v.doc_save_fio.indexOf('Анализатор') === -1) {
                                has_o = true
                            }
                        }
                        if (v.tube.pk === '') {
                            sv = `<span class='no-tube'>Ёмк. ${v.not_received_tubes} не принята${!!v.not_received_why ? ` (${v.not_received_why})` : ''}</span>`
                        }
                    } else {
                        all_o = false
                        if (v.allow_disable_confirm)
                            deffc = `<div class='fastlinks hiddenlinks'><a href='#' onclick='event.preventDefault();reset_confirm(${v.pk}, "${v.title}", ${v.tube.pk || -1});return false;'>Сброс подтверждения</a>`
                    }
                    let t = ''
                    if (v.saved && v.is_norm !== 'normal')
                        t = `title='${iss_isnorm[v.is_norm]}'`
                    $('#issledovaniya').append(`<li num='${v.pk}' class='brdr tb-group-${v.group} issledovaniya-isnorm-${v.is_norm}' ${t} onclick='load_form(${v.research_pk}, ${v.pk}, ${v.template})'><div title='${statuses_titles[status]}' class='status status-${status}'>${statuses[status]}</div>${deffc}</div>${v.title}<br/>${v.tube.pk !== '' ? `<small>Ёмкость: ${v.tube.pk}</small>` : sv}</li>`)

                    const tubessplit = v.tube.pk.split(',')
                    $.each(tubessplit, function (k, vt) {
                        if (pks.indexOf(vt) !== -1) {
                            if (tubessplit.length === 1) {
                                for (let i = 0; i < tubes_active.length; i++) {
                                    if (tubes_active[i].pk === vt) {
                                        tubes_active[i].group = 'tb-group-' + v.group
                                        return
                                    }
                                }
                            }
                            return
                        }
                        pks.push(vt)
                        tubes_active.push({pk: vt, group: 'tb-group-' + v.group})
                    })
                })
                sync_active(!!s)
                if (!select_el)
                    $('#issledovaniya li').first().click()
                else
                    $(`#issledovaniya li[num='${select_el}']`).click()
                $('#issledovaniya-scroll').scrollTop(0)
                if (all_saved) {
                    $('#result-confirm').removeAttr('disabled')
                }
                if (data.all_confirmed && !all_o) {
                    $('#result-print').removeAttr('disabled')
                    $('#result-confirm').attr('disabled', 1)
                }

                $('#loaded-buttons a').fadeIn(100)
            })
        }

        function fix_signs(input) {
            if (/^([<>])\s*\d+$/g.test(input)) {
                input = input.replace(/>/g, '&gt;').replace(/</g, '&lt;')
            }
            return input
        }

        function sort_refs(r) {
            for (let mf of ['m', 'f']) {
                if (r.hasOwnProperty(mf)) {
                    let keys = [], k, i, len, tmp = r[mf]
                    for (k in tmp) {
                        if (tmp.hasOwnProperty(k)) {
                            keys.push(k)
                        }
                    }
                    keys.sort(
                        function (x, y) {
                            let xx = 0
                            let yy = 0
                            try {
                                if (x.toLowerCase().indexOf('все') >= 0) {
                                    xx = -1
                                } else if (x.indexOf('-') >= 0) {
                                    xx = x.split('-').last()
                                } else {
                                    xx = x.replace(/[^\d.]/g, '')
                                }

                                if (y.toLowerCase().indexOf('все') >= 0) {
                                    yy = -1
                                } else if (y.indexOf('-') >= 0) {
                                    yy = y.split('-').last()
                                } else {
                                    yy = y.replace(/[^\d.]/g, '')
                                }

                                xx = parseInt(xx)
                                yy = parseInt(yy)

                                if (x.indexOf('старше') >= 0) {
                                    xx++
                                }
                                if (y.indexOf('старше') >= 0) {
                                    yy++
                                }

                            } catch (err) {
                            }
                            return xx - yy
                        }
                    )
                    len = keys.length
                    r[mf] = {}
                    for (i = 0; i < len; i++) {
                        k = keys[i]
                        r[mf][k] = fix_signs(tmp[k])
                    }
                }
            }
            return r
        }

        function load_form(research_pk, id, templateid) {
            if (typeof templateid === 'undefined') {
                templateid = 0
            }
            sl(true)
            $('.data-research-changed, .data-research-confirmed, .data-dir-changed').hide()

            function callback1(data) {
                template = data
                if (!cached_templates[templateid])
                    cached_templates[templateid] = data

                function callback2(data2) {
                    $('#form-scroll').isLoading('hide')
                    $('#issledovaniya .active').removeClass('active')
                    if (!data2.cached) {
                        researches_cache[research_pk] = {
                            'title': data2.title,
                            'fractions': data2.fractions,
                            'can_comment': data2.can_comment,
                            'no_units_and_ref': data2.no_units_and_ref,
                            'co_executor_mode': data2.co_executor_mode,
                            co_executor_title: data2.co_executor_title,
                        }
                    } else {
                        data2.title = researches_cache[research_pk].title
                        data2.fractions = researches_cache[research_pk].fractions
                        data2.can_comment = researches_cache[research_pk].can_comment
                        data2.no_units_and_ref = researches_cache[research_pk].no_units_and_ref
                        data2.co_executor_mode = researches_cache[research_pk].co_executor_mode
                        data2.co_executor_title = researches_cache[research_pk].co_executor_title
                    }
                    data2.sex = dir_data.client_sex
                    data2.age = dir_data.client_vozrast
                    data2.research_pk = research_pk


                    loaded_fractions = {}
                    $.each(data2.fractions, function (fk, fv) {
                        loaded_fractions[fv.pk] = fv
                        data2.fractions[fk].unit_count = Math.min(data2.fractions[fk].unit.length, 9)
                        data2.fractions[fk].references = sort_refs(data2.fractions[fk].references)
                    })

                    let rendered = !!rendered_form_cache[research_pk]
                    if (!rendered) {
                        const rd = {...data2, laborants, isDoc}
                        console.log(researches_cache[research_pk])
                        console.log(rd)
                        rendered_form_cache[research_pk] = jade.compile(template)(rd)
                    }

                    $('#result-form').html(rendered_form_cache[research_pk])
                    $('#result-form').removeClass('no_units_and_ref')
                    if (data2.no_units_and_ref) {
                        $('#result-form').addClass('no_units_and_ref')
                    }
                    if (rendered)
                        $('#issledovaniye_id').val(data2.res_id)
                    $(`#issledovaniya [num='${data2.res_id}']`).addClass('active')
                    let autoIsF = false
                    let num = 0
                    $.each(data2.fractions, function (fk, fv) {
                        num++
                        if (fv.type !== -1 && fv.type.length > 0 && fv.type[0] !== 'Без вариантов') {
                            if (num === 1) autoIsF = true
                            let ft = $.map(fv.type, function (item) {
                                return {value: item}
                            })
                            let typeVals = new Bloodhound({
                                datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
                                queryTokenizer: Bloodhound.tokenizers.whitespace,
                                identify: function (obj) {
                                    return obj.value
                                },
                                local: ft
                            })

                            function typeValsDefaults(q, sync) {
                                sync(typeVals.get(fv.type))
                            }

                            const $d = $(`[data-pk='${fv.pk}']`)
                            const $val = $d.val()
                            $d.typeahead({
                                minLength: 0,
                                limit: 40,
                                highlight: true,
                                hint: $val === ''
                            }, {
                                name: 'typeval',
                                display: 'value',
                                source: typeValsDefaults,
                                limit: 40
                            })
                            $d.typeahead('val', $val)
                            $d.val($val)
                        }
                    })
                    //f = $('.result-enter:not(.tt-hint)').eq(0);

                    $.ajax({url: '/results/get', cache: false, data: {iss_id: id}}).done(function (data) {
                        $.each(data.results, function (k, v) {
                            v = deescapeHtml(v)
                            if (v !== '')
                                $(`[data-pk='${k}']`).typeahead('close').typeahead('val', v).blur()
                            $(`[data-pk='${k}']`).val(v)
                            $(`[data-div-pk='${k}']`).html(v)
                            if (data.norms[k]) {
                                $(`[data-pk=${k}]`).closest('tr').addClass(`isnorm_${data.norms[k]}`)
                            }
                        })
                        let resync_refs = false
                        $.each(data.refs, function (k, v) {
                            if ($.isEmptyObject(v))
                                return
                            resync_refs = true
                            $(`.fraction-row[data-fraction-pk='${k}']`).attr('data-ref', _.escape(JSON.stringify(v)))
                        })
                        if (resync_refs) {
                            sync_refs()
                        }
                        $('.lab_comment').text(data.comment)
                        try {
                            if (jQuery.type(dready) !== 'undefined' && $.isFunction(dready)) {
                                dready()
                            }
                        } catch (e) {
                            resize()
                        } finally {
                            $('.result-enter.tt-input').eq(0).focus().blur()
                            setTimeout(function () {
                                if ($('.result-enter:not(.tt-hint):textboxEmpty').length) {
                                    $('.result-enter:not(.tt-hint):textboxEmpty').eq(0).focus()
                                }
                                resize()
                            }, 15)
                        }
                    })

                    sync_refs()

                    resize()
                    loaded_research = id
                    datatype = -1
                    const $l = $('#laborant')
                    const $c = $('#coexecutor')
                    if ($l.length) {
                        $l.val(data2.co_executor)
                    }
                    if ($c.length) {
                        $c.val(data2.co_executor2)
                    }
                    if (data2.confirmed) {
                        $('#confirm-btn').attr('disabled', 1)
                        $('#save-btn').attr('disabled', 1)
                        $('#clear-all-btn').attr('disabled', 1)
                        $('#ref-settings-btn').prop('disabled', true)
                        $('#confirm-andsave-btn').attr('disabled', 1)
                        $('.result-enter').prop('readonly', true)
                        if ($l.length) {
                            $l.prop('disabled', true)
                        }
                        if ($c.length) {
                            $c.prop('disabled', true)
                        }
                        datatype = 2
                    } else if (data2.saved) {
                        $('#confirm-btn').removeAttr('disabled')
                        $('#save-btn').removeAttr('disabled')
                        $('#clear-all-btn').removeAttr('disabled')
                        $('#ref-settings-btn').prop('disabled', false)
                        $('#confirm-andsave-btn').removeAttr('disabled')
                        datatype = 1
                    } else {
                        $('#confirm-btn').attr('disabled', 1)
                        $('#save-btn').removeAttr('disabled')
                        $('#clear-all-btn').removeAttr('disabled')
                        $('#ref-settings-btn').prop('disabled', false)
                        $('#confirm-andsave-btn').removeAttr('disabled')
                    }
                    if ($l.length) {
                        $l.selectpicker('refresh')
                    }
                    if ($c.length) {
                        $c.selectpicker('refresh')
                    }
                    hl()
                    $('#result-jade-form').scrollTop(0)
                }

                $.ajaxq('precache', {
                    url: '/researches/get/one',
                    method: 'GET',
                    cache: false,
                    data: {
                        id: id,
                        cached: research_pk in researches_cache
                    }
                }).done(callback2)

            }

            if (!cached_templates[templateid]) {
                $.ajax({
                    url: `{% static 'templates' %}/${templateid}.jade`,
                    type: 'text',
                    cache: false,
                    method: 'GET'
                }).done(callback1)
            } else {
                callback1(cached_templates[templateid])
            }

        }

        function make_refs(r, bordered) {
            let out = ''
            bordered = bordered || false
            if (typeof r === "string") {
                try {
                    r = JSON.parse(r)
                } catch (e) {

                }
            }
            for (let prop in r) {
                if (((prop !== 'Все' && r[prop] !== '') || (prop === 'Все' && r[prop] !== '')) && r.hasOwnProperty(prop)) {
                    out += `<tr>
<td>${prop}</td>
<td class="col-md-6">${r[prop]}</td>
</tr>`
                }
            }
            return `<table class="${bordered ? 'table table-bordered table-condensed' : ''}">` + out + '</table>'
        }

        function sync_refs() {
            $('.fraction-row').each(function () {
                let research_pk = parseInt($(this).attr('data-research-pk'))
                let fraction_pk = parseInt($(this).attr('data-fraction-pk'))
                let ref = $(this).attr('data-ref')
                let fraction = false
                for (let fk in researches_cache[research_pk].fractions) {
                    let f = researches_cache[research_pk].fractions[fk]
                    if (f.pk === fraction_pk) {
                        fraction = f
                        break
                    }
                }
                if (!fraction)
                    return
                if (ref === '') {
                    if (fraction.references.default === -1) {
                        ref = {title: 'Default', about: '', m: fraction.references.m, f: fraction.references.f}
                    } else {
                        ref = fraction.references.available[fraction.references.default]
                    }
                    $(this).attr('data-ref', _.escape(JSON.stringify(ref)))
                } else {
                    ref = JSON.parse(_.unescape(ref))
                }

                ref = sort_refs(ref)

                $('.ref_m', this).html(make_refs(ref.m))
                $('.ref_f', this).html(make_refs(ref.f))
            })
        }

        function refsettings() {
            let research_pk = parseInt($('#research_pk').val())
            let fractions = researches_cache[research_pk].fractions
            $('#refsettings-modal .modal-body').html('')
            for (let prop in fractions) {
                if (fractions.hasOwnProperty(prop) && $(`#result-jade-form`).find(`.fraction-row[data-fraction-pk=${fractions[prop].pk}]:not(.settings)`).length) {
                    let options = ''
                    let selected_ref = $(`.fraction-row[data-fraction-pk='${fractions[prop].pk}']`).attr('data-ref')
                    let n = 0
                    let inav_refs = false
                    for (let rk in fractions[prop].references.available) {
                        if (!fractions[prop].references.available.hasOwnProperty(rk))
                            continue
                        let r = fractions[prop].references.available[rk]
                        let jref = JSON.parse(JSON.stringify(r))
                        let jj = JSON.parse($('<div>').html(selected_ref).text())
                        jj['title'] = jref['title']
                        jj['about'] = jref['about']
                        if (!Object.compare(jj, jref)) {
                            options += `<option value='${_.escape(JSON.stringify(jref))}'>${r.title}</option>`
                        } else {
                            options += `<option selected value='${_.escape(JSON.stringify(jref))}'>${r.title}</option>`
                            inav_refs = true
                        }
                        n++
                    }
                    if (!inav_refs) {
                        options += `<option selected class='custom' value='${selected_ref !== '' && selected_ref !== '{}' ? selected_ref : `{"":""}`}'>Другое...</option>`
                    } else {
                        options += `<option class='custom' value='${_.escape('{"Все":""}')}'>Другое...</option>`
                    }
                    $('#refsettings-modal .modal-body').append(`<div class="row settings" style="border-bottom: 1px solid lightgray;margin-bottom:5px;padding-bottom:5px" data-fraction-pk="${fractions[prop].pk}">
    <div class="col-xs-2">${fractions[prop].title}</div>
    <div class="col-xs-2"><select data-width="100%" class="select-b" onchange="settings_sync_ref(${fractions[prop].pk});">${options}</select></div>
    <div class="col-xs-8"><div class="row preview"></div></div>
</div>`)
                    settings_sync_ref(fractions[prop].pk)
                    update_select(`.settings[data-fraction-pk='${fractions[prop].pk}']`)
                }
            }
            $('#refsettings-modal').modal('show')
            return false
        }

        function ref_form(refs) {
            let ht = ''
            for (let prop in refs) {
                if (!refs.hasOwnProperty(prop))
                    continue
                ht += `<div class='row ref-row'>
<div class='col-xs-6'><input type='text' class='form-control prop-input' value='${prop}' placeholder='Условие' /></div>
<div class='col-xs-6'><input type='text' class='form-control ref-input' value='${refs[prop]}' placeholder='Референс' /></div>
</div>`
            }
            return ht
        }

        function settings_sync_ref(pk) {
            let $row = $(`.settings[data-fraction-pk='${pk}']`)
            let selectval = _.unescape($('select', $row).val())

            if (selectval === '' || selectval === undefined || selectval === 'undefined') {
                selectval = '{}'
            }
            let val = sort_refs(JSON.parse(selectval))
            if ($.isEmptyObject(val)) {
                val = {'': ''}
            }
            if ($(`.settings[data-fraction-pk='${pk}'] option:selected`).is('.custom')) {
                $(`.settings[data-fraction-pk='${pk}'] .preview`).html(`<div class="col-xs-6 table-responsive ref_m">М${ref_form(val.m)}</div><div class="col-xs-6 table-responsive ref_f">Ж${ref_form(val.f)}</div>
                <div class="col-xs-12">
                <div class="row">
                    <div class="col-xs-4"></div>
                    <div class="col-xs-4"><button class="btn btn-default btn-primary-nb btn-sm mt5" onclick="add_subref(${pk})">+</button></div>
                    <div class="col-xs-4"></div>
                </div></div>`)
            } else {
                $(`.settings[data-fraction-pk='${pk}'] .preview`).html(`<div class="col-xs-6 table-responsive ref_m">М${make_refs(val.m, true)}</div><div class="col-xs-6 table-responsive ref_f">Ж${make_refs(val.f, true)}</div>`)
            }
        }

        function add_subref(pk) {
            backsync(pk)
            let $row = $(`.settings[data-fraction-pk='${pk}']`)
            let selectval = _.unescape($('select', $row).val())
            let val = sort_refs(JSON.parse(selectval))

            if (!('' in val.m)) {
                val.m[''] = ''
            }
            if (!('' in val.f)) {
                val.f[''] = ''
            }
            $('select option:selected', $row).attr('value', _.escape(JSON.stringify(val)))
            settings_sync_ref(pk)
        }

        function backsync(pk) {
            let $row = $(`.settings[data-fraction-pk='${pk}']`)
            let selectval = _.unescape($('select', $row).val())
            if (selectval === '') {
                selectval = `{}`
            }
            let val = sort_refs(JSON.parse(selectval))
            if ($('select option:selected', $row).is('.custom')) {
                val.m = {}
                $('.ref_m .ref-row', $row).each(function () {
                    val.m[$('.prop-input', this).val()] = $('.ref-input', this).val()
                })
                val.f = {}
                $('.ref_f .ref-row', $row).each(function () {
                    val.f[$('.prop-input', this).val()] = $('.ref-input', this).val()
                })
            }
            $('select option:selected', $row).attr('value', _.escape(JSON.stringify(sort_refs(val))))
        }

        function apply_refs() {
            $('.settings').each(function () {
                backsync($(this).attr('data-fraction-pk'))
                $(`.fraction-row[data-fraction-pk=${$(this).attr('data-fraction-pk')}]`).attr('data-ref', $('select', this).val())
            })
            sync_refs()
        }

        function fast_search(num) {
            $('#search-field').val(num)
        }

        function dechl() {
            nn--
            if (nn <= 0) {
                hl()
                if (firstrun) {
                    firstrun = false
                    $('#search-field').focus()
                }
            }
        }

        function decsl() {
            nn++
            sl()
        }

        function load_tubes_and_dirs() {
            sl()
            nn++
            $('#tubes-list tbody').isLoading({
                text: 'Загрузка',
                position: 'inside',
                'tpl': loadingtable,
            })
            $('#dirs-list tbody').isLoading({
                text: 'Загрузка',
                position: 'inside',
                'tpl': loadingtable,
            })
            document.querySelector('#dirs-list').scrollTop = 0
            document.querySelector('#tubes-list').scrollTop = 0
            $.ajax({
                url: '/results/loadready',
                data: {
                    datestart: $('[name=datemain-start]').val(),
                    dateend: $('[name=datemain-end]').val(),
                    def: $('[name=def]').prop('checked') ? 1 : 0,
                    lab: lab_pk
                },
                type: 'json',
                method: 'GET'
            }).done(function (data) {
                let tubes_list = document.querySelector('#tubes-list tbody')
                let dirs_list = document.querySelector('#dirs-list tbody')
                let tubes_html = ''
                let dirs_html = ''

                $(tubes_list).isLoading('hide')
                $(dirs_list).isLoading('hide')

                if (data.tubes.length === 0) {
                    tubes_html = '<tr class=\'pulse\'><td>Не найдено</td></tr>'
                } else {
                    for (let v of data.tubes) {
                        tubes_html += `<tr direction='${v.direction}' tube='${v.id}' class='select-tube' title='${v.tube.title}'><td><span style='float: right'>${v.date}</span><div style='background-color: ${v.tube.color}' class='circle'></div> ${v.id}</td></tr>`
                    }
                }
                if (data.directions.length === 0) {
                    dirs_html = '<tr class=\'pulse\'><td>Не найдено</td></tr>'
                } else {
                    for (let v of data.directions) {
                        dirs_html += `<tr direction='${v.id}' class='select-dir'><td class='num'><span style='float: right'>${v.date}</span> ${v.id}</td></tr>`
                    }
                }
                document.querySelector('#tubes-list th small').textContent = data.tubes.length
                document.querySelector('#dirs-list th small').textContent = data.directions.length

                tubes_list.innerHTML = tubes_html
                dirs_list.innerHTML = dirs_html

                sync_active(true)

                $('#tubes-list').perfectScrollbar('update')
                $('#dirs-list').perfectScrollbar('update')
                if (window.location.hash) {
                    const hh = window.location.hash.split(':')
                    if (hh.length === 2) {
                        const h = JSON.parse(decodeURIComponent(hh[1]))
                        history.replaceState(null, null, ' ')

                        fast_search(h.text)

                        if (h.type === '0') {
                            $('#option1').attr('checked', 'checked')
                            $('#option2').removeAttr('checked')
                            $('#option1').parent('.btn').addClass('active')
                            $('#option2').parent('.btn').removeClass('active')
                            type = 0
                        } else {
                            $('#option1').removeAttr('checked')
                            $('#option2').attr('checked', 'checked')
                            $('#option1').parent('.btn').removeClass('active')
                            $('#option2').parent('.btn').addClass('active')
                            type = 1
                        }

                        load_d_fast()
                    }
                }
            }).always(dechl)
        }

        function resize() {
            $('#tubes-list').height($(window).height() - $('#tubes-list').position().top - 110)
            $('#dirs-list').height($(window).height() - $('#dirs-list').position().top - 110)
            $('#issledovaniya-scroll').height($(window).height() - $('#issledovaniya-scroll').position().top - 50)
            if (first_resize) {
                $('#tubes-list').perfectScrollbar()
                $('#dirs-list').perfectScrollbar()
                $('#issledovaniya-scroll').perfectScrollbar()
                first_resize = false
            } else {
                $('#tubes-list').perfectScrollbar('update')
                $('#dirs-list').perfectScrollbar('update')
                $('#issledovaniya-scroll').perfectScrollbar('update')
            }

            $('.floatThead').floatThead('reflow')
            $('.floatThead').floatThead({
                useAbsolutePositioning: false,
                scrollContainer: function ($table) {
                    return $table.closest('div')
                }
            })

            if (!$('#result-jade-form').length) return
            $('#result-jade-form').height($(window).height() - $('#result-jade-form').position().top - 50)
            $('#result-jade-form').perfectScrollbar({suppressScrollX: true})
        }

        let insave = false

        function save(noreload, fc) {
            if (insave)
                return
            insave = true
            $('#confirm-btn').attr('disabled', 1)
            $('#save-btn').attr('disabled', 1)
            $('#clear-all-btn').attr('disabled', 1)
            $('#confirm-andsave-btn').attr('disabled', 1)
            if (datatype === 2) return
            $(this).disabled = true
            let result = {issledovaniye: -1, fractions: {}}
            result.issledovaniye = $('#issledovaniye_id').val()
            result.fractions_ref = {}
            $.each($('.result-enter:not(.group-title):not(.subgroup-value)'), function (k, v) {
                result.fractions[$(v).data('pk')] = $(v).val()
                result.fractions_ref[$(v).data('pk')] = JSON.parse(_.unescape($(`.fraction-row[data-fraction-pk="${$(v).data('pk')}"]`).attr('data-ref')))
            })
            result.comment = $('.lab_comment').val() || ''
            result.fractions = JSON.stringify(result.fractions)
            result.fractions_ref = JSON.stringify(result.fractions_ref)
            result.co_executor = $('#laborant').length ? $('#laborant').val() : '-1'
            result.co_executor2 = $('#coexecutor').length ? $('#coexecutor').val() : '-1'
            $(this).disabled = false
            $.ajax({url: '/results/save', method: 'POST', data: result}).done(function () {
                emit_event('results_save', {pk: result.issledovaniye, user: user_pk, dir: dir_active})
                if (!noreload)
                    reload_fast()
                else {
                    fc()
                }
                $.amaran({
                    'theme': 'awesome ok',
                    'content': {
                        title: 'Результат сохранен',
                        message: '',
                        info: '',
                        icon: 'glyphicon glyphicon-ok'
                    },
                    'position': 'bottom right',
                    delay: 6000
                })
            }).always(() => {
                insave = false
            })
        }

        function confirm_results(ignore) {

            $(this).prop('disabled', true)
            if (has_o && !ignore) {
                $('#dataConfirmModal').find('.modal-body').text($(this).attr('data-confirm'))
                $('#dataConfirmOK').attr('onclick', 'confirm_results(true);$(\'#dataConfirmModal\').modal(\'hide\');return false;')
                $('#dataConfirmModal').modal({show: true})
                return false
            }

            $.ajax({
                'url': '/results/confirm/list',
                method: 'POST',
                type: 'json',
                data: {list: JSON.stringify(iss_pks)}
            }).done(function (data) {
                for (const pk of iss_pks) {
                    emit_event('result_confirm', {pk: pk, dir: dir_active})
                }
                reload_fast()
                if (data.ok) {
                    $.amaran({
                        'theme': 'awesome ok',
                        'content': {
                            title: 'Исследования подтверждены',
                            message: '',
                            info: '',
                            icon: 'glyphicon glyphicon-ok'
                        },
                        'position': 'bottom right',
                        delay: 6000
                    })
                }
                $('#result-confirm').attr('disabled', 1)
            })
        }

        function confirm_result() {
            $('#confirm_result-btn').attr('disabled', 1)
            $('#save-btn').attr('disabled', 1)
            $('#clear-all-btn').attr('disabled', 1)
            $('#confirm_result-andsave-btn').attr('disabled', 1)
            $('#ref-settings-btn').prop('disabled', true)
            $.ajax({
                'url': '/results/confirm',
                method: 'POST',
                data: {pk: $('#issledovaniye_id').val()}
            }).done(function () {
                emit_event('result_confirm', {pk: loaded_research, dir: dir_active})
                reload_fast()
                $.amaran({
                    'theme': 'awesome ok',
                    'content': {
                        title: 'Исследование подтверждено',
                        message: '',
                        info: '',
                        icon: 'glyphicon glyphicon-ok'
                    },
                    'position': 'bottom right',
                    delay: 6000
                })
            })
        }

        function print_results() {
            printResults(dir_data.napr_pk)
            // list_reload = true;
            //$('[direction="' + dir_data.napr_pk + '"]').remove();
        }

        function createjournal() {
            const date = $('[name=date-confirm]').val()
            const v = $('#ist_f').val()
            if (!v) {
                $.amaran({
                    'theme': 'awesome no',
                    'content': {
                        title: 'Не выбран источник финансирования',
                        message: '',
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 5000
                })
                return
            }
            const arr = JSON.parse('[' + v + ']')
            window.open('/results/journal?date=' + date + '&ist_f=' + JSON.stringify(arr) + '&group=' + $('#select-journal-group').val() + '&lab_pk=' + lab_pk, '_blank')
        }

        function createjournalcodes() {
            const date = $('[name=date-confirm]').val()
            const v = $('#ist_f').val()
            if (!v) {
                $.amaran({
                    'theme': 'awesome no',
                    'content': {
                        title: 'Не выбран источник финансирования',
                        message: '',
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 5000
                })
                return
            }
            const arr = JSON.parse('[' + v + ']')
            window.open('/results/journal?date=' + date + '&ist_f=' + JSON.stringify(arr) + '&group=' + $('#select-journal-group').val() + '&codes=1&lab_pk=' + lab_pk, '_blank')
        }

        function createjournaltable() {
            const date = $('[name=date-confirm]').val()
            const v = $('#ist_f').val()
            if (!v) {
                $.amaran({
                    'theme': 'awesome no',
                    'content': {
                        title: 'Не выбран источник финансирования',
                        message: '',
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 5000
                })
                return
            }
            const arr = JSON.parse('[' + v + ']')
            window.open('/results/journal_table?date=' + date + '&ist_f=' + JSON.stringify(arr) + '&lab_pk=' + lab_pk, '_blank')
        }

        function open_fill_form() {
            sl()
            let tubes = new Set()
            fill_researches = {}
            for (let iss of dir_data.issledovaniya) {
                for (let tube of iss.tube.pk.split(',')) {
                    tubes.add(parseInt(tube))
                    if (fill_researches[tube] === undefined)
                        fill_researches[tube] = new Set()
                    fill_researches[tube].add({pk: iss.pk, research_pk: iss.research_pk})
                }
            }
            $('#fillform-tubes').html('')
            for (let tube of tubes) {
                $('#fillform-tubes').append(`<option value='${tube}'>${tube}</option>`)
            }
            $('#fillform-text').val('')
            $('[name=fillform-type][value=empty]').prop('checked', true)
            $('#fillform-modal').modal()
            hl()
        }

        function do_fill() {
            sl()
            let tube = parseInt($('#fillform-tubes').val())
            let all = $('[name=fillform-type]:checked').val() === 'all'
            let researches = fill_researches[tube]
            let text_to_fill = $('#fillform-text').val()
            for (let res of researches) {
                (function (res_pk) {
                    queue_fill.push(res_pk)
                    $.ajaxq('/researches/get/one', {
                        url: '/researches/get/one',
                        method: 'GET',
                        data: {id: res_pk}
                    }).done(function (data) {
                        $.ajaxq('/results/get', {
                            url: '/results/get',
                            type: 'text',
                            method: 'GET',
                            data: {iss_id: res_pk}
                        }).done(function (results_data) {
                            sl()
                            let fractions_data = data.fractions
                            let result = {issledovaniye: res_pk, fractions: {}}
                            let isnorm = results_data.norms
                            results_data = results_data.results
                            for (let fk of Object.keys(fractions_data)) {
                                let fv = fractions_data[fk]
                                fv.pk += ''
                                if ((all || !(fv.pk in results_data) || results_data[fv.pk] === '') && fv.render_type === 0) {
                                    result.fractions[fv.pk] = text_to_fill
                                } else if ((fv.render_type === 1 || !all) && fv.pk in results_data) {
                                    result.fractions[fv.pk] = results_data[fv.pk]
                                }
                            }
                            if (Object.keys(result.fractions).length > 0) {
                                result.fractions = JSON.stringify(result.fractions)
                                $.ajax({
                                    url: '/results/save',
                                    method: 'POST',
                                    data: result
                                }).done(function () {
                                    let index = queue_fill.indexOf(res_pk)
                                    if (index > -1) {
                                        queue_fill.splice(index, 1)
                                    }
                                    if (queue_fill.length === 0) {
                                        hl()
                                        reload_fast()
                                    }
                                    emit_event('results_save', {
                                        pk: result.issledovaniye,
                                        user: user_pk,
                                        dir: dir_active
                                    })
                                })
                            } else {
                                let index = queue_fill.indexOf(res_pk)
                                if (index > -1) {
                                    queue_fill.splice(index, 1)
                                }
                                if (queue_fill.length === 0) {
                                    $('#fill-hide').click()
                                    hl()
                                    reload_fast()
                                }
                            }
                        })
                    })
                })(res.pk)
            }
        }

        function openexeclist() {
            load_researches()
            $('#list-modal').modal()
        }

        function openjournal() {
            $('#journal-modal').modal()
        }

        function dayprint() {
            load_researches('#dayprint-table-researches')
            $('#results-day-modal').modal()
        }

        function deff(status, pk) {
            if (lockdeff) return
            lockdeff = true
            $.ajax({url: '/directions/def', data: {pk: pk, status: status}}).done(function () {
                lockdeff = false
                reload_fast()
            })
        }

        function dayprint_do() {
            if (lockdeff) return
            lockdeff = true
            let researches = []
            $.each($('#dayprint-table-researches .research-sel:checked'), function (k, v) {
                researches.push(parseInt($(v).val()))
            })
            if (researches.length === 0) {
                $.amaran({
                    'theme': 'awesome wrn',
                    'content': {
                        title: 'Печать невозможна',
                        message: 'Ничего не выбрано',
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 6000
                })
                lockdeff = false
                return
            }
            sl()
            $.ajax({
                url: '/results/day',
                data: {
                    date: $('[name=dateday-confirm]').val(),
                    researches: JSON.stringify(researches),
                    otd: $('#print-results-otd').val()
                }
            }).done(function (data) {
                lockdeff = false
                if (Object.keys(data.directions).length > 0) {
                    let strs = []
                    for (let l = 0; l < Object.keys(data.directions).length; l++) {
                        strs = _.union(strs, data.directions[Object.keys(data.directions)[l]])
                    }
                    printResults(strs)
                    $('#results-day-modal').modal('hide')
                } else {
                    $.amaran({
                        'theme': 'awesome wrn',
                        'content': {
                            title: 'Печать невозможна',
                            message: 'Ничего не найдено',
                            info: '',
                            icon: 'fa fa-exclamation'
                        },
                        'position': 'bottom right',
                        delay: 6000
                    })
                }
                hl()
            })
        }

        function createlist(type) {
            let datestart, dateend
            datestart = dateend = ''
            let researches = []
            $.each($('#table-researches .research-sel:checked'), function (k, v) {
                researches.push(parseInt($(v).val()))
            })
            if (researches.length === 0) {
                $.amaran({
                    'theme': 'awesome wrn',
                    'content': {
                        title: 'Создание невозможно',
                        message: 'Ничего не выбрано',
                        info: '',
                        icon: 'fa fa-exclamation'
                    },
                    'position': 'bottom right',
                    delay: 6000
                })
                return
            }
            switch (type) {
                case 2:
                    break
                default:
                    datestart = $('[name=date-start]').val()
                    dateend = $('[name=date-end]').val()
                    break
            }
            switch (type) {
                case 3:
                    window.open(`/mainmenu/receive/execlist?type=nonconfirmed&datestart=${datestart}&dateend=${dateend}&researches=${JSON.stringify(researches)}`, '_blank')
                    break
                default:
                    window.open('/directions/execlist?type=' + type + '&datestart=' + datestart + '&dateend=' + dateend + '&researches=' + JSON.stringify(researches), '_blank')
                    break
            }
        }

        function load_researches(cont) {
            let $o = $('#table-researches')
            if (cont !== undefined)
                $o = $(cont)
            $o.html('')
            $o.append(lang.table_researches_header)
            $.ajax({ // AJAX запрос
                url: '/directory/researches/list?lab_id=' + lab_pk,// Установка адреса и параметров запроса
                dataType: 'json'
            }).done(function (data) {
                if (data.length === 0) {
                    $o.append(lang.table_researches_not_found)
                    return
                }
                $o.html('')
                $o.append(lang.table_researches_header)
                $.each(data, function (k, v) {
                    $o.append(`<label title='${v.fields.ref_title}' class="btn btn-default col-xs-3"><input type="checkbox" name="sel" value="${v.pk}" class="research-sel" autocomplete="off"/> ${v.fields.ref_title}</label>`)
                })
            })
        }

        function reset_confirm(id, rtitle, tube) {
            if (dir_data.hasOwnProperty('in_rmis') && dir_data.in_rmis) {
                alert('Результат уже был загружен в РМИС')
            }
            let msg = `Сбросить подтверждение исследования №${id} - ${rtitle}, ёмкость №${tube}?${dir_data.hasOwnProperty('in_rmis') && dir_data.in_rmis ? ' Результат уже был загружен в РМИС' : ''}`
            let doreset = confirm(msg)
            if (doreset === false || doreset === null) {
                return
            }
            sl()
            $.ajax({
                'url': '/mainmenu/confirm_reset',
                method: 'POST',
                data: {pk: id}
            }).done(function (data) {
                emit_event('result_confirm', {pk: id, dir: dir_active})
                if (data.ok) {
                    reload_fast()
                    $.amaran({
                        'theme': 'awesome ok',
                        'content': {
                            title: 'Подтверждение сброшено',
                            message: `№${id} - ${rtitle}, ёмкость №${tube}`,
                            info: '',
                            icon: 'fa fa-exclamation'
                        },
                        'position': 'bottom right',
                        delay: 6000
                    })
                } else {
                    $.amaran({
                        'theme': 'awesome wrn',
                        'content': {
                            title: 'Ошибка',
                            message: data.msg,
                            info: '',
                            icon: 'glyphicon glyphicon-ok'
                        },
                        'position': 'bottom right',
                        delay: 6000
                    })

                }
            }).always(() => {
                hl()
            })
        }
    </script>
{% endblock %}
