<template>
  <div class="root">
    <div v-if="!checked" class="eds-preloader top-block"><i class="fa fa-spinner"></i> загрузка</div>
    <div v-frag v-else>
      <div class="row top-block">
        <div class="col-xs-3" v-if="!hasCP">
          <div class="eds-status status-error">Плагин CSP не настроен</div>
        </div>
        <div class="col-xs-8" v-else>
          <select class="form-control" v-model="selectedCertificate" v-if="certificatesDisplay.length > 0">
            <option v-for="c in certificatesDisplay" :key="c.thumbprint" :value="c.thumbprint">
              {{ c.name }}
            </option>
          </select>
          <div v-else class="status-error">
            Нет сертификатов
          </div>
        </div>
        <div class="col-xs-4 cert-info" v-if="selectedCertificateObject">
          <div>{{ selectedCertificateObject.thumbprint }}</div>
          <div>{{ selectedCertificateObject.validFrom }} — {{ selectedCertificateObject.validTo }}</div>
        </div>
      </div>
    </div>
    <div class="top-block row">
      <div class="col-xs-6">
        <div class="radio-wrapper">
          <RadioFieldById v-model="filters.mode" :variants="modesAvailable" :disabled="disabledByNumber" />
        </div>
        <treeselect
          class="treeselect-wide treeselect-34px"
          :multiple="false"
          :disable-branch-nodes="true"
          :options="deps"
          :clearable="false"
          placeholder="Подразделение не выбано"
          v-if="filters.mode === 'mo'"
          v-model="filters.department"
          :disabled="disabledByNumber"
        />
      </div>
      <div class="col-xs-6">
        <div class="radio-wrapper">
          <RadioFieldById v-model="filters.status" :variants="STATUSES" :disabled="disabledByNumber" />
        </div>
        <div class="row">
          <div class="col-xs-6">
            <DateFieldNav2 v-model="filters.date" w="100%" :brn="false" :disabled="disabledByNumber" />
          </div>
          <div class="col-xs-6">
            <input type="text" class="form-control" v-model.trim="filters.number" placeholder="номер направления" />
          </div>
        </div>
      </div>
    </div>

    <button class="top-button btn btn-blue-nb2 btn-block" type="button" @click="load(null)">
      <i class="fa fa-search"></i> Поиск
    </button>

    <div class="not-loaded" v-if="!loaded">
      Данные не загружены
    </div>
    <div v-else class="data">
      <div>
        <div class="float-right input-group" style="width: 450px;" v-if="hasAnyChecked">
          <span class="input-group-addon">Роль подписи</span>
          <select class="form-control" v-model="selectedSignatureMode">
            <option v-for="s in commonSignModes" :key="s" :value="s">
              {{ s }}
            </option>
          </select>
          <span class="input-group-btn">
            <button type="button" class="btn btn-default btn-primary-nb" @click="listSign()" :disabled="!selectedSignatureMode">
              Подписать списком
            </button>
          </span>
        </div>
        <button class="btn btn-blue-nb float-right" @click="load(page)" v-else>
          <i class="fa fa-refresh"></i>
        </button>
        <paginate
          v-model="page"
          :page-count="pages"
          :page-range="4"
          :margin-pages="2"
          :click-handler="load"
          prev-text="Назад"
          next-text="Вперёд"
          container-class="pagination"
        />
      </div>
      <table class="table table-bordered table-condensed">
        <colgroup>
          <col style="width: 130px" />
          <col />
          <col />
          <col style="width: 160px" />
          <col style="width: 25px" />
        </colgroup>
        <thead>
          <tr>
            <th>
              № направления
            </th>
            <th>
              Подтверждено
            </th>
            <th>
              Услуги
            </th>
            <th>
              Подписи
            </th>
            <td class="x-cell" :key="`check_${globalCheckStatus}`">
              <label @click.prevent="toggleGlobalCheck" v-if="hasToCheck">
                <input type="checkbox" :checked="globalCheckStatus" />
              </label>
            </td>
          </tr>
        </thead>
        <tbody>
          <tr v-for="r in rows" :key="r.pk" :class="totallySigned(r) && 'tr-ok'">
            <td>
              {{ r.pk }}
            </td>
            <td>{{ r.confirmedAt }}, {{ r.docConfirmation }}</td>
            <td>
              {{ r.services.join('; ') }}
            </td>
            <td class="eds-td cl-td">
              <div>
                <EDSDirection :direction-pk="r.pk" :all_confirmed="true" :documents-prefetched="r.documents" />
              </div>
              <div v-if="totallySigned(r)" class="uploading-status" :class="r.n3number ? 'm-ok' : 'm-error'">
                {{ r.n3number ? 'выгружено в ИЭМК' : 'не выгружено в ИЭМК' }}
              </div>
            </td>
            <td class="x-cell">
              <label v-if="!totallySigned(r)">
                <input type="checkbox" v-model="r.checked" />
              </label>
            </td>
          </tr>
        </tbody>
      </table>
      <div>
        <div class="float-right input-group" style="width: 450px;" v-if="hasAnyChecked">
          <span class="input-group-addon">Роль подписи</span>
          <select class="form-control" v-model="selectedSignatureMode">
            <option v-for="s in commonSignModes" :key="s" :value="s">
              {{ s }}
            </option>
          </select>
          <span class="input-group-btn">
            <button type="button" class="btn btn-default btn-primary-nb" @click="listSign()" :disabled="!selectedSignatureMode">
              Подписать списком
            </button>
          </span>
        </div>
        <button class="btn btn-blue-nb float-right" @click="load(page)" v-else>
          <i class="fa fa-refresh"></i>
        </button>
        <paginate
          v-model="page"
          :page-count="pages"
          :page-range="4"
          :margin-pages="2"
          :click-handler="load"
          prev-text="Назад"
          next-text="Вперёд"
          container-class="pagination"
        />
      </div>
      <div class="founded">
        Найдено записей: <strong>{{ total }}</strong>
      </div>
    </div>
    <transition name="fade">
      <div v-if="signingProcess.active" class="signing-root">
        <div class="signing-inner">
          <div class="signing-header">
            Создание подписей как {{ selectedSignatureMode }}
            <i v-if="signingProcess.progress" class="fa fa-spinner"></i>
            <i v-else class="fa fa-check"></i>
          </div>

          <ProgressBar
            size="large"
            :val="signP"
            :text="
              `${signP}% – ${signingProcess.currentDocument}/${signingProcess.totalDocuments} ${signingProcess.currentOperation}`
            "
            bar-transition="all 0.1s linear"
            text-position="bottom"
            text-align="left"
            :font-size="14"
            text-fg-color="#fff"
            bar-color="#049372"
          />

          <button type="button" class="btn btn-default btn-primary-nb" @click="load(page)" :disabled="signingProcess.progress">
            Закрыть и перезагрузить список
          </button>

          <table class="table table-condensed table-bordered">
            <thead>
              <tr>
                <th>Направление</th>
                <th>Документ</th>
                <th>Статус</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="p in signingProcess.log" :key="`${p.direction}_${p.type}`" :class="p.status ? 'tr-ok' : 'tr-error'">
                <td>{{ p.direction }}</td>
                <td>{{ p.type }}</td>
                <td :class="p.status ? 'm-ok' : 'm-error'">{{ p.status ? 'ОК' : 'ОШИБКА' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </transition>
  </div>
</template>

<script lang="ts">
import {
  getSystemInfo, getUserCertificates, createDetachedSignature, createHash,
} from 'crypto-pro';
import moment from 'moment';
import Vue from 'vue';
import Component from 'vue-class-component';
import Treeselect from '@riophae/vue-treeselect';
import '@riophae/vue-treeselect/dist/vue-treeselect.css';
import Paginate from 'vuejs-paginate';
import ProgressBar from 'vue-simple-progress';

import * as actions from '@/store/action-types';
import usersPoint from '@/api/user-point';
import RadioFieldById from '@/fields/RadioFieldById.vue';
import DateFieldNav2 from '@/fields/DateFieldNav2.vue';
import EDSDirection from '@/ui-cards/EDSDirection.vue';
import { convertSubjectNameToTitle } from '@/utils';

const MODES = [
  { id: 'mo', label: 'Подписи медицинской организации' },
  { id: 'my', label: 'Мои документы' },
];

const STATUSES = [
  { id: 'need', label: 'Требуют подписи' },
  { id: 'ok-role', label: 'Подписаны выбранной ролью' },
  { id: 'ok-full', label: 'Подписаны полностью' },
];

@Component({
  components: {
    Treeselect,
    RadioFieldById,
    DateFieldNav2,
    Paginate,
    EDSDirection,
    ProgressBar,
  },
  data() {
    return {
      systemInfo: null,
      certificates: [],
      selectedCertificate: null,
      checked: false,
      hasCP: false,
      filters: {
        mode: null,
        department: null,
        status: STATUSES[0].id,
        number: '',
        date: moment().format('YYYY-MM-DD'),
      },
      MODES,
      STATUSES,
      users: [],
      page: 1,
      pages: 0,
      total: 0,
      loaded: false,
      rows: [],
      selectedSignatureMode: null,
      signingProcess: {
        active: false,
        progress: false,
        totalDocuments: 0,
        currentDocument: 0,
        log: [],
        currentOperation: '',
      },
    };
  },
  mounted() {
    this.getEDSStatus();
    this.loadUsers();
  },
  watch: {
    modesAvailable: {
      immediate: true,
      handler() {
        if (!this.modesAvailable.find(m => m.id === this.filters.mode)) {
          this.filters.mode = this.modesAvailable[0].id;
        }
      },
    },
    commonSignModes: {
      immediate: true,
      handler() {
        if (this.commonSignModes.length === 0) {
          this.selectedSignatureMode = null;
          return;
        }

        if (this.commonSignModes.includes(this.selectedSignatureMode)) {
          return;
        }

        // eslint-disable-next-line prefer-destructuring
        this.selectedSignatureMode = this.commonSignModes[0];
      },
    },
  },
})
export default class EDS extends Vue {
  systemInfo: any;

  certificates: any[];

  selectedCertificate: string | null;

  checked: boolean;

  hasCP: boolean;

  filters: any;

  MODES: any[];

  STATUSES: any[];

  users: any[];

  page: number;

  pages: number;

  total: number;

  loaded: boolean;

  rows: any[];

  selectedSignatureMode: any;

  signingProcess: any;

  get accessToMO() {
    return (this.$store.getters.user_data.groups || []).includes('ЭЦП Медицинской организации');
  }

  get modesAvailable() {
    return this.MODES.filter(m => m.id !== 'mo' || this.accessToMO);
  }

  get edsAllowedSign() {
    return this.$store.getters.user_data.eds_allowed_sign;
  }

  get commonSignModes() {
    const m = [];
    for (const r of this.rows.filter(v => v.checked)) {
      for (const d of r.documents) {
        for (const e of d.empty) {
          if (!m.includes(e) && this.edsAllowedSign.includes(e)) {
            m.push(e);
          }
        }
      }
    }
    return m;
  }

  get disabledByNumber() {
    return Boolean(this.filters.number);
  }

  get selectedCertificateObject() {
    if (!this.selectedCertificate) {
      return {};
    }

    const cert = this.certificates.find(c => c.thumbprint === this.selectedCertificate);
    if (!cert) {
      return {};
    }

    return {
      thumbprint: cert.thumbprint,
      validFrom: moment(cert.validFrom).format('DD.MM.YYYY HH:mm'),
      validTo: moment(cert.validTo).format('DD.MM.YYYY HH:mm'),
    };
  }

  get certificatesDisplay() {
    return this.certificates.map(c => ({
      thumbprint: c.thumbprint,
      name: convertSubjectNameToTitle(null, c.subjectName, c.name),
    }));
  }

  get deps() {
    return [
      ...this.users.map(d => ({ id: Number(d.id.split('-')[1]) || -1, label: d.label })),
      { id: -1, label: 'Все отделения' },
    ];
  }

  get globalCheckStatus() {
    return this.rows.every(r => r.checked && this.totallySigned(r));
  }

  get hasAnyChecked() {
    return this.rows.some(r => r.checked && !this.totallySigned(r));
  }

  get rowsChecked() {
    return this.rows.filter(r => r.checked && !this.totallySigned(r));
  }

  get hasToCheck() {
    return this.hasCP && this.checked && this.selectedCertificate && this.rows.some(r => !this.totallySigned(r));
  }

  get signP() {
    return Math.ceil((this.signingProcess.currentDocument / this.signingProcess.totalDocuments) * 1000) / 10;
  }

  async loadUsers() {
    await this.$store.dispatch(actions.INC_LOADING);
    const { users } = await usersPoint.loadUsersByGroup({ group: '*' });
    this.users = users;
    this.filters.department = this.$store.getters.user_data?.department?.pk || null;
    await this.$store.dispatch(actions.DEC_LOADING);
  }

  async getEDSStatus() {
    try {
      this.systemInfo = await getSystemInfo();
      console.log('getStatus', true, this.systemInfo);
      this.hasCP = true;
      try {
        this.certificates = await getUserCertificates();
      } catch (e) {
        console.log('getCertificates error');
        console.error(e);
        this.checked = false;
      }
      if (this.certificates.length > 0) {
        console.log('getCertificates', true, this.certificates);
        this.selectedCertificate = (this.certificates[0] || {}).thumbprint;
      } else {
        console.log('getCertificates', false);
      }
      this.checked = true;
    } catch (e) {
      console.error(e);
      console.log('getStatus', false);
      this.hasCP = false;
      this.checked = true;
    }
  }

  async load(page_to_load) {
    if (this.signingProcess.active) {
      this.rows = [];
    }
    const prevSelectedSignatureMode = this.selectedSignatureMode;
    this.signingProcess.progress = false;
    this.signingProcess.active = false;
    if (page_to_load !== null) {
      this.page = page_to_load;
    } else {
      this.page = 1;
    }
    await this.$store.dispatch(actions.INC_LOADING);
    const {
      rows, page, pages, total,
    } = await this.$api('/directions/eds/to-sign', this, ['filters', 'page']);
    this.rows = rows.map(r => ({ ...r, checked: false }));
    this.page = page;
    this.pages = pages;
    this.total = total;
    await this.$store.dispatch(actions.DEC_LOADING);
    this.loaded = true;
    if (this.commonSignModes.includes(prevSelectedSignatureMode)) {
      this.selectedSignatureMode = prevSelectedSignatureMode;
    }
  }

  toggleGlobalCheck() {
    const newStatus = !this.globalCheckStatus;
    this.rows = this.rows.map(r => ({ ...r, checked: newStatus && !this.totallySigned(r) }));
  }

  // eslint-disable-next-line class-methods-use-this
  totallySigned(r) {
    if (r.totallySigned) {
      return true;
    }

    return r.documents.every(x => x.empty.length === 0);
  }

  async listSign() {
    if (this.signingProcess.active) {
      return;
    }
    try {
      await this.$dialog.confirm(`Подтвердите подпись всех выбранных документов как "${this.selectedSignatureMode}"`);
    } catch (_) {
      return;
    }
    this.signingProcess.active = true;
    this.signingProcess.progress = true;
    this.signingProcess.log = [];
    this.signingProcess.currentOperation = '';
    this.signingProcess.totalDocuments = this.rowsChecked.reduce((a, b) => a + b.documents.length, 0);
    this.signingProcess.currentDocument = 0;
    for (const r of this.rowsChecked) {
      try {
        this.signingProcess.currentOperation = `${r.pk} получение документов`;
        const { documents } = await this.$api('/directions/eds/documents', {
          pk: r.pk,
        });
        for (const d of documents) {
          if (d.signatures[this.selectedSignatureMode]) {
            this.signingProcess.currentDocument++;
            continue;
          }
          const docTitle = `${r.pk} ${d.type}`;
          const docToLog = {
            direction: r.pk,
            type: d.type,
            status: false,
          };
          try {
            let body = d.fileContent;
            if (d.type === 'PDF') {
              body = Uint8Array.from(atob(body), c => c.charCodeAt(0));
            }
            const isString = typeof body === typeof '';

            const bodyEncoded = isString ? body : new Uint8Array(body);

            this.signingProcess.currentOperation = `${docTitle} создание подписи`;
            const m = await createHash(bodyEncoded);
            const sign = await createDetachedSignature(this.selectedCertificate, m);

            this.signingProcess.currentOperation = `${docTitle} отправка подписи`;
            const { ok, message } = await this.$api('/directions/eds/add-sign', {
              pk: d.pk,
              sign,
              mode: this.selectedSignatureMode,
            });

            if (ok) {
              const msg = `Подпись успешно добавлена: ${r.pk}, ${d.type}, ${this.selectedSignatureMode}`;
              this.$root.$emit('msg', 'ok', msg, 1500);
              docToLog.status = true;
            } else {
              this.$root.$emit('msg', 'error', message);
            }
          } catch (e) {
            console.error(e);
            this.$root.$emit('msg', 'error', 'Ошибка создания подписи!');
          }
          this.signingProcess.log.push(docToLog);
          this.signingProcess.currentDocument++;
        }
      } catch (e) {
        console.log(e);
        this.$root.$emit('msg', 'error', `Ошибка подписи ${r.pk}`);
        const docToLog = {
          direction: r.pk,
          type: '???',
          status: false,
        };
        this.signingProcess.log.push(docToLog);
      }
    }
    this.signingProcess.progress = false;
    this.signingProcess.currentOperation = '';
  }
}
</script>

<style lang="scss" scoped>
.eds-preloader {
  padding: 20px;
  text-align: center;
}

.status {
  &-error {
    color: #cf3a24;
  }

  &-ok {
    color: #049372;
  }
}

.cert-info {
  font-size: 12px;
}

.eds-status {
  padding: 5px 0;
}

.top-block {
  margin: 0 0 10px 0;
  padding: 5px 0;
  border-radius: 4px;
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.4);
  background: #fff;

  &.row,
  &.eds-preloader {
    min-height: 44px;
  }
}

.root {
  margin: -10px auto 0 auto;
  max-width: 1200px;
  padding: 0 10px;
}

.radio-wrapper {
  margin-bottom: 5px;
}

.top-button {
  margin-bottom: 15px;
}

.not-loaded {
  text-align: center;
  color: grey;
}

.data {
  padding: 0 20px;
}

.founded {
  text-align: center;
  padding: 5px;
  margin-top: -5px;
}

.tr-ok {
  background-color: rgba(#049372, 0.1);
}

.tr-error {
  background-color: rgba(#930425, 0.1);
}

.m-ok {
  font-weight: bold;
  color: #049372;
}

.m-error {
  font-weight: bold;
  color: #930425;
}

.eds-td > div {
  display: flex;
  flex-direction: row;
  margin-left: -5px;
}

.signing {
  &-root {
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(1px);
    z-index: 100000;
  }

  &-inner {
    margin: 0 auto;
    max-width: 1200px;
    width: 100%;
    padding: 0 10px;
    height: 100%;
    padding: 50px 0;
    overflow-y: auto;

    .btn {
      width: auto !important;
      margin: 10px auto 20px auto !important;
      display: block;
    }

    .table {
      background: #fff;
    }
  }

  &-header {
    text-align: center;
    margin-bottom: 10px;
    color: #fff;
    font-size: 20px;
    font-weight: bold;
  }
}

.uploading-status {
  margin-left: 0 !important;
  text-align: center;
  display: block !important;
}
</style>

<style>
.pagination {
  margin-top: 0 !important;
}
</style>
